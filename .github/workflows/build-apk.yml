name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'
        accept-android-sdk-licenses: true
        
    - name: Find project root directory
      id: find_root
      run: |
        echo "ðŸ“ Procurando diretÃ³rio raiz do projeto..."
        pwd
        echo ""
        echo "ðŸ“ Listando diretÃ³rios..."
        ls -la
        echo ""
        echo "ðŸ“ Procurando por gradlew..."
        if [ -f "./gradlew" ]; then
          echo "âœ… gradlew encontrado na raiz"
          echo "PROJECT_ROOT=." >> $GITHUB_OUTPUT
        elif [ -d "MRIT Control/MRIT Control" ] && [ -f "MRIT Control/MRIT Control/gradlew" ]; then
          echo "âš ï¸ gradlew encontrado em 'MRIT Control/MRIT Control'"
          echo "PROJECT_ROOT=MRIT Control/MRIT Control" >> $GITHUB_OUTPUT
        elif [ -d "MRIT Control" ] && [ -f "MRIT Control/gradlew" ]; then
          echo "âš ï¸ gradlew encontrado em 'MRIT Control'"
          echo "PROJECT_ROOT=MRIT Control" >> $GITHUB_OUTPUT
        else
          echo "âŒ gradlew nÃ£o encontrado! Buscando recursivamente..."
          GRADLEW_PATH=$(find . -name "gradlew" -type f -not -path "./.git/*" -not -path "./.gradle/*" | head -1)
          if [ -n "$GRADLEW_PATH" ]; then
            GRADLEW_DIR=$(dirname "$GRADLEW_PATH" | sed 's|^\./||')
            echo "âœ… gradlew encontrado em: $GRADLEW_PATH"
            echo "PROJECT_ROOT=$GRADLEW_DIR" >> $GITHUB_OUTPUT
          else
            echo "âŒ gradlew nÃ£o encontrado em nenhum lugar!"
            find . -name "gradlew" -type f 2>/dev/null | head -5
            exit 1
          fi
        fi
        
    - name: Verify project structure
      working-directory: ${{ steps.find_root.outputs.PROJECT_ROOT }}
      run: |
        echo "ðŸ“ Verificando estrutura do projeto..."
        echo "ðŸ“ DiretÃ³rio atual: $(pwd)"
        ls -la
        echo ""
        echo "ðŸ“ Verificando se gradlew existe..."
        if [ -f "./gradlew" ]; then
          echo "âœ… gradlew encontrado"
          ls -lh ./gradlew
        else
          echo "âŒ gradlew nÃ£o encontrado!"
          exit 1
        fi
        echo ""
        echo "ðŸ“ Verificando gradle wrapper..."
        if [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
          echo "âœ… gradle-wrapper.properties encontrado"
          cat gradle/wrapper/gradle-wrapper.properties
        else
          echo "âŒ gradle-wrapper.properties nÃ£o encontrado!"
          exit 1
        fi
        if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "âœ… gradle-wrapper.jar encontrado"
          ls -lh gradle/wrapper/gradle-wrapper.jar
        else
          echo "âš ï¸ gradle-wrapper.jar nÃ£o encontrado. Baixando..."
          mkdir -p gradle/wrapper
          curl -f -L -o gradle/wrapper/gradle-wrapper.jar "https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar" || {
            echo "âš ï¸ Tentando URL alternativa..."
            curl -f -L -o gradle/wrapper/gradle-wrapper.jar "https://services.gradle.org/distributions/gradle-wrapper.jar"
          }
          if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "âœ… gradle-wrapper.jar baixado com sucesso"
            ls -lh gradle/wrapper/gradle-wrapper.jar
          else
            echo "âŒ Erro ao baixar gradle-wrapper.jar"
            exit 1
          fi
        fi
        chmod +x ./gradlew
        echo "âœ… Gradle wrapper pronto para uso"
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
      
    - name: Build Debug APK
      working-directory: ${{ steps.find_root.outputs.PROJECT_ROOT }}
      run: ./gradlew assembleDebug --stacktrace --no-daemon --warning-mode all
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        
    - name: Build Release APK
      working-directory: ${{ steps.find_root.outputs.PROJECT_ROOT }}
      run: ./gradlew assembleRelease --stacktrace --no-daemon --warning-mode all
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      
    - name: Locate Debug APK
      working-directory: ${{ steps.find_root.outputs.PROJECT_ROOT }}
      run: |
        APK_DEBUG="app/build/outputs/apk/debug/app-debug.apk"
        
        if [ -f "$APK_DEBUG" ]; then
          echo "APK_DEBUG_PATH=${{ steps.find_root.outputs.PROJECT_ROOT }}/$APK_DEBUG" >> $GITHUB_ENV
          ls -lh "$APK_DEBUG"
          echo "âœ… APK Debug localizado em: $APK_DEBUG"
        else
          echo "âš ï¸ APK Debug nÃ£o encontrado!"
          find app/build -name "*.apk" || echo "Nenhum APK encontrado"
        fi
        
    - name: Locate Release APK (signed or unsigned)
      working-directory: ${{ steps.find_root.outputs.PROJECT_ROOT }}
      run: |
        APK_SIGNED="app/build/outputs/apk/release/app-release.apk"
        APK_UNSIGNED="app/build/outputs/apk/release/app-release-unsigned.apk"
        
        if [ -f "$APK_SIGNED" ]; then
          APK_PATH="$APK_SIGNED"
        elif [ -f "$APK_UNSIGNED" ]; then
          APK_PATH="$APK_UNSIGNED"
        else
          echo "âš ï¸ APK Release nÃ£o encontrado! Verificando estrutura de diretÃ³rios..."
          find app/build -name "*.apk" || echo "Nenhum APK encontrado"
          ls -la app/build/outputs/apk/ || echo "DiretÃ³rio nÃ£o existe"
          APK_PATH=""
        fi
        
        if [ -n "$APK_PATH" ]; then
          echo "APK_RELEASE_PATH=${{ steps.find_root.outputs.PROJECT_ROOT }}/$APK_PATH" >> $GITHUB_ENV
          ls -lh "$APK_PATH"
          echo "âœ… APK Release localizado em: $APK_PATH"
        fi
      
    - name: Upload Debug APK artifact
      uses: actions/upload-artifact@v4
      if: env.APK_DEBUG_PATH != ''
      with:
        name: app-debug-apk
        path: ${{ env.APK_DEBUG_PATH }}
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload Release APK artifact
      uses: actions/upload-artifact@v4
      if: env.APK_RELEASE_PATH != ''
      with:
        name: app-release-apk
        path: ${{ env.APK_RELEASE_PATH }}
        retention-days: 30
        if-no-files-found: warn
        
    - name: Generate build summary
      run: |
        echo "## ðŸ“¦ Build APK - Sucesso!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download APK" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "O APK estÃ¡ disponÃ­vel na seÃ§Ã£o de **Artifacts** abaixo." >> $GITHUB_STEP_SUMMARY
