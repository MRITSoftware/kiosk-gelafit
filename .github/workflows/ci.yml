name: CI - Build and Validate

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  validate:
    name: Validar CÃ³digo e SQL
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validar arquivos SQL
      run: |
        echo "ðŸ” Validando arquivos SQL..."
        SQL_FILES=$(find . -name "*.sql" -not -path "./.git/*" -not -path "./.gradle/*" -not -path "./build/*")
        
        if [ -z "$SQL_FILES" ]; then
          echo "âš ï¸ Nenhum arquivo SQL encontrado"
        else
          echo "ðŸ“„ Arquivos SQL encontrados:"
          echo "$SQL_FILES"
          
          # ValidaÃ§Ã£o bÃ¡sica de sintaxe SQL
          for sql_file in $SQL_FILES; do
            echo "âœ… Validando: $sql_file"
            # Verifica se o arquivo nÃ£o estÃ¡ vazio
            if [ ! -s "$sql_file" ]; then
              echo "âŒ Erro: $sql_file estÃ¡ vazio"
              exit 1
            fi
            # Verifica se contÃ©m comandos SQL bÃ¡sicos
            if ! grep -qiE "(CREATE|INSERT|UPDATE|SELECT|ALTER|DROP)" "$sql_file"; then
              echo "âš ï¸ Aviso: $sql_file pode nÃ£o conter comandos SQL vÃ¡lidos"
            fi
          done
        fi
        
    - name: Verificar estrutura do projeto
      run: |
        echo "ðŸ“ Verificando estrutura do projeto..."
        
        # Verifica se Ã© um projeto Android
        if [ -f "build.gradle.kts" ] || [ -f "build.gradle" ]; then
          echo "âœ… Projeto Android detectado"
        else
          echo "âš ï¸ build.gradle nÃ£o encontrado"
        fi
        
        # Verifica se hÃ¡ arquivos Kotlin
        KOTLIN_FILES=$(find . -name "*.kt" -not -path "./.git/*" -not -path "./.gradle/*" -not -path "./build/*" | wc -l)
        if [ "$KOTLIN_FILES" -gt 0 ]; then
          echo "âœ… $KOTLIN_FILES arquivo(s) Kotlin encontrado(s)"
        fi
        
        # Verifica se hÃ¡ documentaÃ§Ã£o
        if [ -f "README.md" ]; then
          echo "âœ… README.md encontrado"
        fi

  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'
        accept-android-sdk-licenses: true
        
    - name: Find gradlew and set working directory
      id: find_gradlew
      run: |
        echo "ðŸ” Procurando gradlew..."
        echo "Estrutura do diretÃ³rio:"
        ls -la | head -20
        
        # Procura gradlew em vÃ¡rios locais possÃ­veis
        GRADLEW_PATH=$(find . -name "gradlew" -type f -not -path "./.git/*" -not -path "./.gradle/*" | head -1)
        
        if [ -n "$GRADLEW_PATH" ]; then
          # Remove ./ do inÃ­cio do caminho
          GRADLEW_DIR=$(dirname "$GRADLEW_PATH" | sed 's|^\./||')
          if [ "$GRADLEW_DIR" = "." ]; then
            echo "WORKING_DIR=." >> $GITHUB_ENV
          else
            echo "WORKING_DIR=$GRADLEW_DIR" >> $GITHUB_ENV
          fi
          echo "âœ… Gradlew encontrado em: $GRADLEW_PATH"
          echo "âœ… Working directory definido como: ${{ env.WORKING_DIR }}"
        else
          echo "âŒ gradlew nÃ£o encontrado em nenhum lugar!"
          echo "Buscando todos os arquivos gradlew:"
          find . -name "gradlew" -type f 2>/dev/null || echo "Nenhum gradlew encontrado"
          echo "Buscando diretÃ³rios com build.gradle:"
          find . -name "build.gradle*" -type f 2>/dev/null | head -5
          exit 1
        fi
        
    - name: Setup Gradle Wrapper
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        if [ ! -f "./gradlew" ]; then
          echo "âŒ gradlew nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "ðŸ“¥ Baixando gradle-wrapper.jar..."
          mkdir -p gradle/wrapper
          curl -f -L -o gradle/wrapper/gradle-wrapper.jar \
            "https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar" || {
            curl -f -L -o gradle/wrapper/gradle-wrapper.jar \
              "https://services.gradle.org/distributions/gradle-wrapper.jar" || {
              echo "âŒ Erro ao baixar gradle-wrapper.jar"
              exit 1
            }
          }
        fi
        
        chmod +x ./gradlew
        echo "âœ… Gradle wrapper configurado"
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
      
    - name: Build Debug APK
      working-directory: ${{ env.WORKING_DIR }}
      run: ./gradlew assembleDebug --stacktrace --no-daemon
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        
    - name: Build Release APK
      working-directory: ${{ env.WORKING_DIR }}
      run: ./gradlew assembleRelease --stacktrace --no-daemon
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: ${{ env.WORKING_DIR }}/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: app-release-apk
        path: ${{ env.WORKING_DIR }}/app/build/outputs/apk/release/app-release*.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: Build Summary
      run: |
        echo "## âœ… Build ConcluÃ­do com Sucesso!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š InformaÃ§Ãµes do Build" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Data**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- APK Debug e Release disponÃ­veis na seÃ§Ã£o de Artifacts" >> $GITHUB_STEP_SUMMARY
