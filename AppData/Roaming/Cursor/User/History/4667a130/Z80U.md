# Sistema de Valida√ß√£o de Cache - Player MRIT

## Funcionalidade Implementada

Sistema inteligente que verifica automaticamente se o cache est√° realmente pronto e atualiza o campo `cache` na tabela `displays` de acordo.

## Como Funciona

### 1. **Verifica√ß√£o Autom√°tica**
- ‚úÖ Verifica se 80% ou mais dos v√≠deos est√£o em cache
- ‚úÖ Atualiza status automaticamente no banco
- ‚úÖ Verifica√ß√£o peri√≥dica a cada 30 segundos
- ‚úÖ Verifica√ß√£o quando playlist muda

### 2. **Crit√©rios de Cache Pronto**
- **80% dos v√≠deos** devem estar em cache
- **Arquivos v√°lidos** (tamanho > 0 bytes)
- **Apenas v√≠deos** s√£o considerados (imagens n√£o contam)

### 3. **Momentos de Verifica√ß√£o**
- **Mudan√ßa na playlist**: Ap√≥s 2 segundos
- **Verifica√ß√£o peri√≥dica**: A cada 30 segundos
- **Troca de c√≥digo**: Imediatamente marca como n√£o pronto
- **Playlist vazia**: Marca como n√£o pronto

## Comandos de Debug

### Verifica√ß√£o Completa
```javascript
// Verificar cache e atualizar status:
mritDebug.verificarCacheCompleto();
```

### Verificar Status no Banco
```javascript
// Ver status atual no banco:
mritDebug.verificarStatusCacheBanco();
```

### Limpar Cache e Status
```javascript
// Limpar cache local e marcar como n√£o pronto:
mritDebug.limparCacheEStatus();
```

### For√ßar Status
```javascript
// Marcar como pronto:
mritDebug.forcarStatusCache(true);

// Marcar como n√£o pronto:
mritDebug.forcarStatusCache(false);
```

## Logs Detalhados

O sistema mostra logs completos:

```
üîç Verificando se cache est√° realmente pronto...
‚úÖ V√≠deo em cache: video1.mp4 (1024000 bytes)
‚ùå V√≠deo n√£o em cache: video2.mp4
‚úÖ V√≠deo em cache: video3.mp4 (2048000 bytes)
üìä Cache: 2/3 v√≠deos (66.7%)
üìä Status: ‚ùå N√£o pronto
üîÑ Atualizando status do cache para ABC123: n√£o pronto
‚úÖ Status do cache atualizado: n√£o pronto
```

## Cen√°rios de Uso

### 1. **Nova Playlist**
```javascript
// 1. Playlist √© carregada
// 2. Cache √© preenchido automaticamente
// 3. Ap√≥s 2 segundos: verifica√ß√£o autom√°tica
// 4. Status √© atualizado no banco
```

### 2. **Adicionar Item na Playlist**
```javascript
// 1. Novo item √© adicionado
// 2. Cache √© atualizado
// 3. Verifica√ß√£o autom√°tica ap√≥s 2 segundos
// 4. Status √© recalculado e atualizado
```

### 3. **Trocar de Tela**
```javascript
// 1. C√≥digo da tela muda
// 2. Cache anterior √© limpo
// 3. Status √© marcado como n√£o pronto
// 4. Nova playlist √© carregada
// 5. Cache √© preenchido e verificado
```

### 4. **Verifica√ß√£o Peri√≥dica**
```javascript
// 1. A cada 30 segundos
// 2. Verifica se cache ainda est√° v√°lido
// 3. Atualiza status se necess√°rio
// 4. Mant√©m sincroniza√ß√£o com banco
```

## Configura√ß√µes

### Percentual M√≠nimo
```javascript
const cachePronto = percentualCache >= 80; // 80% dos v√≠deos
```

### Intervalo de Verifica√ß√£o
```javascript
setInterval(async () => {
  // Verifica√ß√£o a cada 30 segundos
}, 30000);
```

### Delay para Verifica√ß√£o
```javascript
setTimeout(async () => {
  // Verifica√ß√£o ap√≥s mudan√ßa na playlist
}, 2000);
```

## Fun√ß√µes Implementadas

### `verificarEAtualizarStatusCache()`
- Verifica cada v√≠deo da playlist
- Calcula percentual de cache
- Atualiza status no banco
- Retorna `true`/`false`

### `mritDebug.verificarCacheCompleto()`
- Executa verifica√ß√£o completa
- Mostra logs detalhados
- Atualiza status no banco

### `mritDebug.limparCacheEStatus()`
- Limpa cache local
- Marca como n√£o pronto no banco
- √ötil para testes

## Exemplo de Uso

### Teste Completo
```javascript
// 1. Carregar playlist
// 2. Aguardar cache ser preenchido
// 3. Verificar status:
mritDebug.verificarCacheCompleto();

// 4. Verificar no banco:
mritDebug.verificarStatusCacheBanco();

// 5. Adicionar novo item na playlist
// 6. Aguardar verifica√ß√£o autom√°tica
// 7. Verificar status novamente:
mritDebug.verificarCacheCompleto();
```

### Monitoramento
```javascript
// Verificar status atual:
mritDebug.verificarStatusCacheBanco();

// Se status estiver incorreto, for√ßar:
mritDebug.forcarStatusCache(true);

// Limpar e recome√ßar:
mritDebug.limparCacheEStatus();
mritDebug.forcarCache();
```

## Vantagens do Sistema

### 1. **Autom√°tico**
- N√£o precisa interven√ß√£o manual
- Verifica e atualiza sozinho
- Mant√©m sincroniza√ß√£o com banco

### 2. **Inteligente**
- Considera percentual de cache
- Verifica arquivos v√°lidos
- Detecta mudan√ßas na playlist

### 3. **Confi√°vel**
- Verifica√ß√£o peri√≥dica
- Logs detalhados
- Tratamento de erros

### 4. **Flex√≠vel**
- Configur√°vel via debug
- For√ßa status quando necess√°rio
- Limpa cache quando necess√°rio

## Troubleshooting

### Cache n√£o atualiza
```javascript
// Verificar se est√° funcionando:
mritDebug.verificarCacheCompleto();

// For√ßar atualiza√ß√£o:
mritDebug.forcarStatusCache(true);
```

### Status incorreto
```javascript
// Verificar no banco:
mritDebug.verificarStatusCacheBanco();

// Corrigir:
mritDebug.forcarStatusCache(false); // Limpar
mritDebug.forcarStatusCache(true);  // Marcar como pronto
```

### Cache n√£o √© detectado
```javascript
// Verificar caches locais:
mritDebug.checkAllCache();

// Limpar e recome√ßar:
mritDebug.limparCacheEStatus();
mritDebug.forcarCache();
```

## Notas Importantes

1. **Percentual**: 80% dos v√≠deos devem estar em cache
2. **Verifica√ß√£o**: A cada 30 segundos automaticamente
3. **Mudan√ßas**: Verifica√ß√£o ap√≥s 2 segundos da mudan√ßa
4. **Logs**: Acompanhe o console para debug
5. **Banco**: Status √© sempre atualizado no banco
6. **Limpeza**: Cache √© limpo ao trocar de tela
