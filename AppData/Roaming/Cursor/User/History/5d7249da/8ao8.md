# Tokens Expostos e Plano de Testes

## ğŸ”´ TOKENS EXPOSTOS NO CÃ“DIGO

Encontrei os seguintes tokens hardcoded no cÃ³digo-fonte:

### 1. **Supabase Anon Key** (CRÃTICO)
**Token encontrado em 3 arquivos:**

#### a) `lib/backend/supabase/supabase.dart` (linhas 6-7)
```dart
String _kSupabaseAnonKey =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpaHlob3Ficmt3YmZ1ZHR0ZXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU1NTUwMjcsImV4cCI6MjAzMTEzMTAyN30.XtBTlSiqhsuUIKmhAMEyxofV-dRst7240n912m4O4Us';
```

#### b) `lib/backend/api_requests/api_calls.dart` (linhas 142-145, 175-176)
```dart
'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpaHlob3Ficmt3YmZ1ZHR0ZXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU1NTUwMjcsImV4cCI6MjAzMTEzMTAyN30.XtBTlSiqhsuUIKmhAMEyxofV-dRst7240n912m4O4Us',
'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpaHlob3Ficmt3YmZ1ZHR0ZXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU1NTUwMjcsImV4cCI6MjAzMTEzMTAyN30.XtBTlSiqhsuUIKmhAMEyxofV-dRst7240n912m4O4Us',
```

#### c) `lib/custom_code/actions/fila_relatorio_vendas_lote.dart` (linhas 30-33)
```dart
'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpaHlob3Ficmt3YmZ1ZHR0ZXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU1NTUwMjcsImV4cCI6MjAzMTEzMTAyN30.XtBTlSiqhsuUIKmhAMEyxofV-dRst7240n912m4O4Us',
'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpaHlob3Ficmt3YmZ1ZHR0ZXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU1NTUwMjcsImV4cCI6MjAzMTEzMTAyN30.XtBTlSiqhsuUIKmhAMEyxofV-dRst7240n912m4O4Us',
```

**Risco:** âš ï¸ **ALTO** - Este Ã© o token anÃ´nimo do Supabase. Embora seja pÃºblico por design, ele deve estar protegido por Row Level Security (RLS) no Supabase. Se o RLS nÃ£o estiver configurado corretamente, pode permitir acesso nÃ£o autorizado aos dados.

---

### 2. **Firebase API Key** (MÃ‰DIO)
**Token encontrado em:**

#### `lib/backend/firebase/firebase_config.dart` (linha 8)
```dart
apiKey: "AIzaSyAGkXm6K0jUg7cka9JQRDe-ykCMS0E2qG0",
```

**Risco:** âš ï¸ **MÃ‰DIO** - A API Key do Firebase Ã© pÃºblica por design, mas deve ter restriÃ§Ãµes de domÃ­nio/app configuradas no Console do Firebase. Se nÃ£o estiver restrita, pode ser usada por terceiros.

---

### 3. **URLs Hardcoded** (BAIXO)
- Supabase URL: `https://kihyhoqbrkwbfudttevo.supabase.co`
- API Geladeira: `http://MRITSoftware.pythonanywhere.com/ligar_placa`

**Risco:** âš ï¸ **BAIXO** - URLs nÃ£o sÃ£o secretas, mas hardcoding dificulta mudanÃ§as de ambiente.

---

## âœ… SOLUÃ‡ÃƒO: Mover para VariÃ¡veis de Ambiente

### Passo 1: Criar arquivo `.env` (nÃ£o commitar no git)
```env
SUPABASE_URL=https://kihyhoqbrkwbfudttevo.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
FIREBASE_API_KEY=AIzaSyAGkXm6K0jUg7cka9JQRDe-ykCMS0E2qG0
GELADEIRA_API_URL=http://MRITSoftware.pythonanywhere.com/ligar_placa
```

### Passo 2: Adicionar dependÃªncia `flutter_dotenv`
```yaml
dependencies:
  flutter_dotenv: ^5.1.0
```

### Passo 3: Atualizar cÃ³digo para usar variÃ¡veis de ambiente
```dart
// lib/backend/supabase/supabase.dart
import 'package:flutter_dotenv/flutter_dotenv.dart';

String _kSupabaseUrl = dotenv.env['SUPABASE_URL'] ?? '';
String _kSupabaseAnonKey = dotenv.env['SUPABASE_ANON_KEY'] ?? '';
```

### Passo 4: Adicionar ao `.gitignore`
```
.env
.env.local
.env.*.local
```

---

## ğŸ§ª PLANO DE TESTES RECOMENDADO

Baseado na anÃ¡lise do cÃ³digo, aqui estÃ£o os testes prioritÃ¡rios:

### 1. **Testes UnitÃ¡rios** (Alta Prioridade)

#### a) **AppState - Gerenciamento de Estado**
**Arquivo:** `test/unit/app_state_test.dart`
```dart
- test('adiciona item ao carrinho corretamente')
- test('remove item do carrinho')
- test('calcula total geral corretamente')
- test('persiste estado no SharedPreferences')
- test('limpa carrinho ao fazer logout')
- test('aplica cupom de desconto corretamente')
```

#### b) **ValidaÃ§Ã£o de CPF**
**Arquivo:** `test/unit/cpf_validator_test.dart`
```dart
- test('valida CPF vÃ¡lido')
- test('rejeita CPF invÃ¡lido')
- test('rejeita CPF com dÃ­gitos repetidos')
- test('formata CPF corretamente')
```

#### c) **CÃ¡lculos de PreÃ§o**
**Arquivo:** `test/unit/price_calculator_test.dart`
```dart
- test('calcula total com mÃºltiplos itens')
- test('aplica desconto de cupom percentual')
- test('calcula total com cupom de valor fixo')
- test('formata moeda brasileira corretamente')
```

#### d) **Fila Offline de RelatÃ³rios**
**Arquivo:** `test/unit/offline_queue_test.dart`
```dart
- test('salva item na fila quando offline')
- test('envia fila quando volta online')
- test('nÃ£o duplica itens na fila')
- test('limpa fila apÃ³s envio bem-sucedido')
```

### 2. **Testes de IntegraÃ§Ã£o** (Alta Prioridade)

#### a) **Fluxo de Pagamento PIX**
**Arquivo:** `test/integration/pix_payment_test.dart`
```dart
- test('cria pagamento PIX com sucesso')
- test('verifica status de pagamento pendente')
- test('detecta pagamento aprovado')
- test('expira pagamento apÃ³s timeout')
- test('cancela pagamento corretamente')
```

#### b) **Fluxo de Pagamento CartÃ£o**
**Arquivo:** `test/integration/card_payment_test.dart`
```dart
- test('processa pagamento dÃ©bito')
- test('processa pagamento crÃ©dito')
- test('verifica status do pagamento')
- test('cancela pagamento de cartÃ£o')
```

#### c) **Abertura de Geladeira**
**Arquivo:** `test/integration/geladeira_test.dart`
```dart
- test('abre geladeira apÃ³s pagamento aprovado')
- test('tenta novamente se primeira tentativa falhar')
- test('chama suporte apÃ³s mÃºltiplas falhas')
- test('envia relatÃ³rio antes de abrir geladeira')
```

### 3. **Testes de Widget** (MÃ©dia Prioridade)

#### a) **Tela Principal**
**Arquivo:** `test/widget/tela_principal_test.dart`
```dart
- testWidgets('exibe produtos corretamente')
- testWidgets('mostra carrinho vazio quando nÃ£o hÃ¡ itens')
- testWidgets('exibe contador de itens no carrinho')
- testWidgets('inicia timer regressivo apÃ³s login')
- testWidgets('mostra modal de login quando CPF vazio')
```

#### b) **Carrinho de Compras**
**Arquivo:** `test/widget/carrinho_test.dart`
```dart
- testWidgets('exibe itens do carrinho')
- testWidgets('permite remover item do carrinho')
- testWidgets('atualiza quantidade de itens')
- testWidgets('calcula total corretamente')
- testWidgets('aplica cupom de desconto')
```

#### c) **Pagamento PIX**
**Arquivo:** `test/widget/pagamento_pix_test.dart`
```dart
- testWidgets('exibe QR Code corretamente')
- testWidgets('mostra status pendente')
- testWidgets('mostra status aprovado')
- testWidgets('exibe timer regressivo')
- testWidgets('permite cancelar pagamento')
```

### 4. **Testes de API** (Alta Prioridade)

#### a) **Chamadas Mercado Pago**
**Arquivo:** `test/api/mercado_pago_test.dart`
```dart
- test('cria pagamento PIX via API')
- test('verifica status via API')
- test('trata erro de API corretamente')
- test('valida resposta da API')
```

#### b) **Chamadas Supabase**
**Arquivo:** `test/api/supabase_test.dart`
```dart
- test('busca produtos do Supabase')
- test('salva relatÃ³rio de vendas')
- test('salva relatÃ³rio de nÃ£o pagos')
- test('trata erro de conexÃ£o')
```

### 5. **Testes de IntegraÃ§Ã£o End-to-End** (MÃ©dia Prioridade)

#### a) **Fluxo Completo de Compra**
**Arquivo:** `test/e2e/compra_completa_test.dart`
```dart
- test('fluxo completo: login -> produtos -> carrinho -> pagamento -> abertura')
- test('fluxo com cupom de desconto')
- test('fluxo com pagamento cancelado')
- test('fluxo com timeout de pagamento')
```

### 6. **Testes de Performance** (Baixa Prioridade)

#### a) **Performance de Carregamento**
**Arquivo:** `test/performance/load_test.dart`
```dart
- test('carrega lista de produtos em tempo aceitÃ¡vel')
- test('cache funciona corretamente')
- test('nÃ£o faz requisiÃ§Ãµes desnecessÃ¡rias')
```

---

## ğŸ“¦ DEPENDÃŠNCIAS DE TESTE NECESSÃRIAS

Adicione ao `pubspec.yaml`:

```yaml
dev_dependencies:
  flutter_test:
    sdk: flutter
  mockito: ^5.4.4
  build_runner: ^2.4.7
  integration_test:
    sdk: flutter
  flutter_dotenv: ^5.1.0
```

---

## ğŸ¯ PRIORIZAÃ‡ÃƒO DE TESTES

### ğŸ”´ **CRÃTICO - Implementar Primeiro:**
1. Testes de cÃ¡lculo de preÃ§os e totais
2. Testes de fluxo de pagamento PIX
3. Testes de abertura de geladeira
4. Testes de fila offline

### ğŸŸ¡ **IMPORTANTE - Implementar Depois:**
5. Testes de widget da tela principal
6. Testes de carrinho de compras
7. Testes de integraÃ§Ã£o com APIs

### ğŸŸ¢ **DESEJÃVEL - Implementar Por Ãšltimo:**
8. Testes E2E completos
9. Testes de performance
10. Testes de acessibilidade

---

## ğŸ“ EXEMPLO DE TESTE UNITÃRIO

Aqui estÃ¡ um exemplo prÃ¡tico para comeÃ§ar:

```dart
// test/unit/app_state_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:gela_fit_g_o/app_state.dart';
import 'package:gela_fit_g_o/backend/schema/structs/index.dart';

void main() {
  group('FFAppState - Carrinho', () {
    late FFAppState appState;

    setUp(() {
      appState = FFAppState();
      appState.itensSacola = [];
      appState.totalGeral = 0.0;
    });

    test('adiciona item ao carrinho corretamente', () {
      final produto = DtprodutosStruct(
        nomeProduto: 'Produto Teste',
        preco: 10.0,
        quantidade: 5,
        // ... outros campos
      );

      appState.addToItensSacola(produto);

      expect(appState.itensSacola.length, 1);
      expect(appState.itensSacola.first.nomeProduto, 'Produto Teste');
    });

    test('calcula total geral corretamente', () {
      final produto1 = DtprodutosStruct(preco: 10.0, quantidade: 2);
      final produto2 = DtprodutosStruct(preco: 5.0, quantidade: 3);

      appState.addToItensSacola(produto1);
      appState.addToItensSacola(produto2);

      // Simular cÃ¡lculo (ajustar conforme lÃ³gica real)
      appState.totalGeral = appState.itensSacola
          .map((p) => (p.preco ?? 0) * (p.quantidade ?? 0))
          .fold(0.0, (a, b) => a + b);

      expect(appState.totalGeral, 35.0); // (10*2) + (5*3) = 35
    });
  });
}
```

---

## ğŸš€ PRÃ“XIMOS PASSOS

1. **Imediato:** Mover tokens para variÃ¡veis de ambiente
2. **Esta semana:** Implementar testes unitÃ¡rios crÃ­ticos (cÃ¡lculos, carrinho)
3. **PrÃ³xima semana:** Implementar testes de integraÃ§Ã£o (pagamentos)
4. **MÃªs que vem:** Completar testes de widget e E2E

---

**Nota:** O token do Mercado Pago (`tokenmp`) parece estar sendo obtido dinamicamente do banco de dados via `tkMaquininha`, o que Ã© correto! âœ…

