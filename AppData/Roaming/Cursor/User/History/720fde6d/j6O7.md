# üöÄ Guia de Integra√ß√£o com Supabase

## ‚úÖ O Que Foi Criado

### üìÅ Arquivos Criados

```
lib/
‚îú‚îÄ‚îÄ supabase.ts              ‚Üê Cliente Supabase (p√∫blico e admin)
‚îî‚îÄ‚îÄ supabase-client.ts       ‚Üê Fun√ß√µes auxiliares para DB

types/
‚îî‚îÄ‚îÄ database.ts              ‚Üê Tipos TypeScript do banco (PT-BR)

hooks/
‚îî‚îÄ‚îÄ useSupabase.ts           ‚Üê Hooks React personalizados

.env.local.example           ‚Üê Exemplo de configura√ß√£o
```

---

## ‚öôÔ∏è 1. Configurar Vari√°veis de Ambiente

### Copie o arquivo de exemplo:
```bash
cp .env.local.example .env.local
```

### Edite `.env.local` e adicione suas credenciais:

```env
# Supabase (pegue do dashboard: Settings ‚Üí API)
NEXT_PUBLIC_SUPABASE_URL=https://seu-projeto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sua-chave-publica-aqui
SUPABASE_SERVICE_ROLE_KEY=sua-chave-service-role-aqui

# JWT Secret (gere uma string aleat√≥ria)
JWT_SECRET=sua-chave-secreta-para-jwt

# URL da aplica√ß√£o
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## üìä 2. Schema do Banco de Dados

### O banco j√° est√° configurado com nomes em PT-BR:

- ‚úÖ **empresas** (ao inv√©s de clients)
- ‚úÖ **usuarios** (ao inv√©s de users)
- ‚úÖ **documentos** (ao inv√©s de documents)
- ‚úÖ **pastas** (ao inv√©s de folders)
- ‚úÖ **etiquetas** (ao inv√©s de tags)
- ‚úÖ **comentarios** (ao inv√©s de comments)
- ‚úÖ **notificacoes** (ao inv√©s de notifications)
- ‚úÖ E todas as outras tabelas em portugu√™s!

---

## üíª 3. Como Usar no C√≥digo

### Exemplo 1: Buscar Documentos

```typescript
// app/dashboard/page.tsx
'use client'

import { useDocumentos } from '@/hooks/useSupabase'
import { useEffect } from 'react'

export default function Dashboard() {
  const empresaId = 'seu-empresa-id' // Pegar do contexto/sess√£o
  
  const { documentos, carregando, erro } = useDocumentos(empresaId)

  if (carregando) return <div>Carregando...</div>
  if (erro) return <div>Erro: {erro}</div>

  return (
    <div>
      <h1>Documentos</h1>
      {documentos.map(doc => (
        <div key={doc.id}>
          <h2>{doc.titulo}</h2>
          <p>Status: {doc.status}</p>
          <p>Enviado por: {doc.enviado_por_usuario?.nome}</p>
        </div>
      ))}
    </div>
  )
}
```

### Exemplo 2: Criar Documento

```typescript
// app/api/documentos/route.ts
import { NextResponse } from 'next/server'
import { criarDocumento, registrarLog } from '@/lib/supabase-client'

export async function POST(request: Request) {
  try {
    const formData = await request.formData()
    const arquivo = formData.get('file') as File
    
    // 1. Upload do arquivo para Supabase Storage (implementar depois)
    // const caminhoArquivo = await uploadArquivo(arquivo)
    
    // 2. Criar registro no banco
    const documento = await criarDocumento({
      titulo: formData.get('titulo') as string,
      descricao: formData.get('descricao') as string,
      nome_arquivo: arquivo.name,
      tamanho_arquivo: arquivo.size,
      tipo_arquivo: arquivo.type,
      caminho_arquivo: `/uploads/${arquivo.name}`, // tempor√°rio
      empresa_id: formData.get('empresaId') as string,
      enviado_por: formData.get('usuarioId') as string,
      pasta_id: formData.get('pastaId') as string || undefined,
      etiquetas: JSON.parse(formData.get('etiquetas') as string || '[]')
    })

    // 3. Registrar log de auditoria
    await registrarLog({
      usuario_id: documento.enviado_por,
      acao: 'documento.criado',
      tipo_recurso: 'documento',
      recurso_id: documento.id,
      empresa_id: documento.empresa_id,
      metadados: { titulo: documento.titulo }
    })

    return NextResponse.json({ documento })
  } catch (error: any) {
    return NextResponse.json(
      { erro: error.message },
      { status: 400 }
    )
  }
}
```

### Exemplo 3: Buscar com Filtros

```typescript
import { buscarDocumentos } from '@/lib/supabase-client'

// Buscar documentos pendentes
const { documentos } = await buscarDocumentos(empresaId, {
  status: 'pendente',
  limite: 20,
  offset: 0
})

// Buscar documentos de uma pasta espec√≠fica
const { documentos: docsPasta } = await buscarDocumentos(empresaId, {
  pastaId: 'pasta-uuid-aqui'
})
```

### Exemplo 4: Notifica√ß√µes em Tempo Real

```typescript
'use client'

import { useNotificacoes } from '@/hooks/useSupabase'

export function NotificationBell({ usuarioId }: { usuarioId: string }) {
  const { notificacoes, naoLidas, carregando } = useNotificacoes(usuarioId)

  return (
    <div>
      <button>
        üîî Notifica√ß√µes
        {naoLidas > 0 && (
          <span className="badge">{naoLidas}</span>
        )}
      </button>
      
      {notificacoes.map(notif => (
        <div key={notif.id} className={notif.lida ? 'lida' : 'nao-lida'}>
          <h4>{notif.titulo}</h4>
          <p>{notif.mensagem}</p>
        </div>
      ))}
    </div>
  )
}
```

### Exemplo 5: Coment√°rios

```typescript
import { buscarComentarios, criarComentario } from '@/lib/supabase-client'

// Buscar coment√°rios de um documento
const comentarios = await buscarComentarios(documentoId)

// Criar novo coment√°rio
const novoComentario = await criarComentario({
  documento_id: documentoId,
  usuario_id: usuarioId,
  conteudo: 'Meu coment√°rio aqui',
  interno: false, // false = p√∫blico, true = s√≥ admin v√™
})
```

### Exemplo 6: Estat√≠sticas

```typescript
'use client'

import { useEstatisticas } from '@/hooks/useSupabase'

export function DashboardStats({ empresaId }: { empresaId: string }) {
  const { estatisticas, carregando } = useEstatisticas(empresaId)

  if (carregando) return <div>Carregando...</div>

  return (
    <div className="grid grid-cols-4 gap-4">
      <div className="card">
        <h3>Usu√°rios</h3>
        <p className="text-3xl">{estatisticas?.total_usuarios}</p>
      </div>
      
      <div className="card">
        <h3>Documentos</h3>
        <p className="text-3xl">{estatisticas?.total_documentos}</p>
      </div>
      
      <div className="card">
        <h3>Armazenamento</h3>
        <p className="text-3xl">
          {(estatisticas?.armazenamento_utilizado || 0) / 1024 / 1024} MB
        </p>
      </div>
      
      <div className="card">
        <h3>Pastas</h3>
        <p className="text-3xl">{estatisticas?.total_pastas}</p>
      </div>
    </div>
  )
}
```

---

## üîê 4. Autentica√ß√£o

### Implementar Login com Supabase Auth

```typescript
// app/api/auth/login/route.ts
import { NextResponse } from 'next/server'
import { supabase } from '@/lib/supabase'
import { buscarUsuario, registrarLog } from '@/lib/supabase-client'

export async function POST(request: Request) {
  try {
    const { email, senha } = await request.json()

    // 1. Autenticar com Supabase Auth
    const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
      email,
      password: senha
    })

    if (authError) {
      return NextResponse.json(
        { erro: 'Email ou senha incorretos' },
        { status: 401 }
      )
    }

    // 2. Buscar dados completos do usu√°rio
    const usuario = await buscarUsuario(authData.user.id)

    // 3. Registrar log
    await registrarLog({
      usuario_id: usuario.id,
      acao: 'usuario.login',
      tipo_recurso: 'auth',
      recurso_id: usuario.id,
      empresa_id: usuario.empresa_id || undefined
    })

    return NextResponse.json({
      usuario,
      sessao: authData.session
    })
  } catch (error: any) {
    return NextResponse.json(
      { erro: error.message },
      { status: 500 }
    )
  }
}
```

---

## üì¶ 5. Storage de Arquivos (Pr√≥ximo Passo)

Para armazenar arquivos reais, voc√™ precisar√°:

```typescript
// lib/supabase-storage.ts (criar depois)
import { supabase } from './supabase'

export async function uploadArquivo(
  arquivo: File,
  empresaId: string
) {
  const nomeArquivo = `${Date.now()}_${arquivo.name}`
  const caminho = `${empresaId}/${nomeArquivo}`

  const { data, error } = await supabase.storage
    .from('documentos') // nome do bucket
    .upload(caminho, arquivo)

  if (error) throw error

  // Obter URL p√∫blica
  const { data: urlData } = supabase.storage
    .from('documentos')
    .getPublicUrl(caminho)

  return {
    caminho,
    url: urlData.publicUrl
  }
}
```

---

## üéØ 6. Migrar Sistema Atual

### Passos para Migra√ß√£o:

1. **‚úÖ FEITO**: Schema criado no Supabase
2. **‚úÖ FEITO**: Tipos TypeScript gerados
3. **‚úÖ FEITO**: Fun√ß√µes auxiliares criadas
4. **‚úÖ FEITO**: Hooks React criados

### Pr√≥ximos Passos:

5. **Substituir `lib/database.ts`** pelas fun√ß√µes de `lib/supabase-client.ts`
6. **Atualizar componentes** para usar os novos hooks
7. **Migrar autentica√ß√£o** para Supabase Auth
8. **Configurar Storage** para upload de arquivos
9. **Testar tudo** com dados reais

---

## üß™ 7. Testar a Integra√ß√£o

### Teste 1: Verificar Conex√£o

```typescript
// app/teste/page.tsx
import { supabase } from '@/lib/supabase'

export default async function Teste() {
  const { data: empresas, error } = await supabase
    .from('empresas')
    .select('*')

  if (error) return <div>Erro: {error.message}</div>

  return (
    <div>
      <h1>Teste de Conex√£o</h1>
      <p>‚úÖ Conectado ao Supabase!</p>
      <p>Empresas encontradas: {empresas?.length}</p>
      <pre>{JSON.stringify(empresas, null, 2)}</pre>
    </div>
  )
}
```

### Teste 2: Verificar RLS

Tente buscar dados com diferentes usu√°rios para garantir que as pol√≠ticas RLS est√£o funcionando.

---

## üìö 8. Refer√™ncias

### Fun√ß√µes Dispon√≠veis em `lib/supabase-client.ts`:

- `buscarDocumentos(empresaId, filtros?)`
- `buscarDocumento(id)`
- `criarDocumento(documento)`
- `atualizarStatusDocumento(documentoId, status, usuarioId)`
- `buscarDocumentosFullText(empresaId, consulta)`
- `buscarPastas(empresaId)`
- `criarPasta(pasta)`
- `buscarEtiquetas(empresaId)`
- `criarEtiqueta(etiqueta)`
- `buscarComentarios(documentoId)`
- `criarComentario(comentario)`
- `buscarNotificacoes(usuarioId, naoLidas?)`
- `marcarNotificacaoComoLida(notificacaoId)`
- `criarNotificacao(notificacao)`
- `buscarUsuario(id)`
- `buscarUsuariosPorEmpresa(empresaId)`
- `adicionarFavorito(usuarioId, documentoId)`
- `removerFavorito(usuarioId, documentoId)`
- `verificarFavorito(usuarioId, documentoId)`
- `obterEstatisticasEmpresa(empresaId)`
- `registrarLog(log)`
- `buscarLogsAuditoria(empresaId, limite?)`
- `registrarAtividade(atividade)`
- `buscarAtividadesRecentes(empresaId, limite?)`

### Hooks Dispon√≠veis em `hooks/useSupabase.ts`:

- `useDocumentos(empresaId, filtros?)`
- `useNotificacoes(usuarioId)`
- `useEtiquetas(empresaId)`
- `usePastas(empresaId)`
- `useEstatisticas(empresaId)`
- `useRastrearVisualizacao(documentoId)`

---

## ‚úÖ Checklist de Integra√ß√£o

- [x] Depend√™ncias instaladas
- [x] Cliente Supabase configurado
- [x] Tipos TypeScript criados
- [x] Fun√ß√µes auxiliares criadas
- [x] Hooks React criados
- [ ] Vari√°veis de ambiente configuradas (.env.local)
- [ ] Teste de conex√£o funcionando
- [ ] Componentes atualizados para usar Supabase
- [ ] Autentica√ß√£o migrada
- [ ] Storage configurado
- [ ] Sistema testado end-to-end

---

## üÜò Problemas Comuns

### Erro: "Vari√°veis de ambiente n√£o configuradas"
**Solu√ß√£o:** Crie o arquivo `.env.local` com as credenciais do Supabase

### Erro: "permission denied for table X"
**Solu√ß√£o:** Verifique se as pol√≠ticas RLS est√£o ativas e se o usu√°rio est√° autenticado

### Erro: "relation X does not exist"
**Solu√ß√£o:** Execute o schema SQL no Supabase (supabase-schema.sql)

---

**Agora voc√™ est√° pronto para usar o Supabase com nomes em PT-BR! üöÄ**



